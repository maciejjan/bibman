#!/usr/bin/perl

# This file is part of Bibman -- a console tool for managing BibTeX files.
# Copyright 2017, Maciej Sumalvico <macjan@o2.pl>

# Bibman is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Bibman is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Bibman. If not, see <http://www.gnu.org/licenses/>.

use strict;
use warnings;
use feature 'unicode_strings';
use Curses;
use Pod::Man;
use Pod::Usage;

use Bibman::MainScreen;
use Bibman::StatusBar;

use constant VERSION => "0.1-alpha";

my $INPUT_FILE;
my $arg = shift @ARGV;
while (defined($arg)) {
  if (($arg eq "-h") || ($arg eq "--help")) {
    print_help();
  } elsif (($arg eq "-v") || ($arg eq "--version")) {
    print_version();
  } elsif ($arg eq "--man") {
    print_manpage();
  } else {
    $INPUT_FILE = $arg;
    last;
  }
  $arg = shift @ARGV;
}

if (!defined($INPUT_FILE)) {
  print "ERROR: no input file supplied.\n\n";
  print_help();
} elsif (!-f $INPUT_FILE) {
  print "ERROR: file $INPUT_FILE does not exist.\n\n";
  print_help();
}

my $win = new Curses;
initscr;
raw;
keypad($win, 1);
noecho();
curs_set(0);

start_color;
use_default_colors;
init_pair(StatusBar::INFO, COLOR_GREEN, -1);
init_pair(StatusBar::ERROR, COLOR_RED, -1);

my $main = new MainScreen();
$main->open_bibliography($INPUT_FILE);
$main->show($win);

endwin;

sub print_help {
  pod2usage({ -noperldoc => 1, -verbose => 99, -sections => "SYNOPSIS|OPTIONS" });
}

sub print_version {
  print "bibman " . VERSION . "\n";
  exit 0;
}

sub print_manpage {
  my $parser = Pod::Man->new(release => VERSION, section => 1);
  $parser->parse_file($0);
  exit 0;
}

=head1 NAME

bibman - a console tool for managing BibTeX files

=head1 SYNOPSIS

bibman [options] FILE

=head1 OPTIONS

 -h, --help                print help and exit
 -v, --version             print version information and exit
 --man                     print the manual page and exit

=head1 DESCRIPTION

TODO

=head1 COMMANDS

=head1 KEY BINDINGS

=head1 LICENSE

GPLv3 or later

=head1 LINKS

=head1 BUGS

=cut
